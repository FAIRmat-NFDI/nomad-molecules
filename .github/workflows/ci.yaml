name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - debug/ci-workflow
  pull_request:
    branches:
      - main
      - debug/ci-workflow

jobs:
  lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install project in editable mode
        run: pip install -e .

      - name: Install linting tools
        run: pip install ruff structlog

      - name: Lint with Ruff
        run: ruff check .

  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install project in editable mode
        run: pip install -e .

      - name: Show installed nomad-lab version
        run: |
          echo "nomad-lab version:"
          pip show nomad-lab
          obabel -V


      - name: Install test dependencies
        # run: pip install pytest structlog
        run: pip install .[all]  # make sure nomad-normalizing is included here
      - name: List registered NOMAD normalizers (importlib.metadata)
              run: |
                python - << 'EOF'
                import importlib.metadata
                eps = [
                    ep.name
                    for ep in importlib.metadata.entry_points()
                    if ep.group == 'nomad.normalizer'
                ]
                print("NOMAD normalizers discovered:", eps)
                EOF

      - name: Run tests
        run: pytest -q
